<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Ratio Speed Challenge (Complex Stage)</title>
    <style>
        /* General Styling and Animations (Keeping styles consistent) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .game-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            max-width: 650px;
            width: 100%;
            text-align: center;
            transition: all 0.5s ease-in-out;
        }

        h1 {
            color: #1a73e8; 
            margin-bottom: 5px;
            font-size: 2em;
        }
        
        /* Start Screen */
        #start-screen {
            padding: 30px;
        }
        #start-button {
            padding: 15px 35px;
            background-color: #00a859;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        #start-button:hover {
            background-color: #008a48;
            transform: scale(1.03);
        }

        /* Game Area */
        #data-area {
            background-color: #e6eef5;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #1a73e8;
            text-align: left;
        }

        .data-point {
            font-size: 1.1em;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
        }

        .data-label {
            font-weight: 600;
            color: #34495e;
        }

        #ratio-goal {
            font-size: 1.8em;
            font-weight: 700;
            color: #d93025;
            margin: 20px 0 10px;
            animation: none; 
        }
        
        #ratio-goal.conceptual-goal {
            color: #1a73e8; 
            font-size: 1.6em;
            text-align: center;
        }
        #ratio-goal.complex-goal {
            color: #d93025; 
            font-size: 1.5em;
            text-align: center;
        }


        /* Hint and Input Area */
        #hint-display {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            border: 1px solid #ffeeba;
            display: none; 
        }

        .dual-input-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            flex-grow: 1;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9em;
        }

        .input-area-toggle {
            display: none;
        }

        /* Single Input for calculation ratios */
        #single-input-area {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #single-answer-input {
            padding: 12px;
            width: 60%;
            border: 3px solid #ccc;
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            margin-right: 10px;
            transition: border-color 0.3s;
        }
        
        /* Conceptual Text Input */
        #conceptual-input-area {
            display: none;
            justify-content: center;
            align-items: center;
        }
        #conceptual-answer-input {
            padding: 12px;
            width: 80%;
            border: 3px solid #ccc;
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            margin-right: 10px;
            transition: border-color 0.3s;
            text-transform: uppercase;
        }

        /* Buttons */
        #submit-button, #hint-button {
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 5px;
        }
        #submit-button {
            background-color: #1a73e8;
            color: white;
            border: none;
        }
        #hint-button {
            background-color: #fbbc05;
            color: #34495e;
            border: none;
        }

        /* Timer */
        #timer-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 25px 0 15px;
            height: 20px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background-color: #00a859;
            transition: width 0.1s linear;
        }

        #score-display {
            font-size: 1.5em;
            font-weight: 700;
            color: #00a859;
            margin-top: 15px;
        }

        /* Feedback Animation */
        .feedback {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 10px;
            animation: fade-in-out 1s ease-out;
        }
        .correct-feedback { color: #00a859; }
        .incorrect-feedback { color: #d93025; }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-10px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }

        /* Game Over Screen Buttons */
        .game-over-buttons button {
            margin: 10px;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
        }

        #restart-button {
            background-color: #1a73e8;
            color: white;
        }

        #review-button {
            background-color: #fbbc05;
            color: #34495e;
        }

        /* Review Window (Modal) Styling */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 30px;
            border-radius: 15px;
            width: 80%; 
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: left;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .mistake-item {
            border: 2px solid #d93025;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background-color: #fde8e7;
        }
        .mistake-item.hint-used {
            border-color: #fbbc05;
            background-color: #fffbe9;
        }

        .mistake-item.conceptual-mistake {
            border-color: #1a73e8;
            background-color: #e6eef5;
        }
         .mistake-item.complex-mistake {
            border-color: #7d33b0; /* Purple for complex */
            background-color: #f0e6f7;
        }

        .mistake-title {
            font-weight: bold;
            font-size: 1.2em;
            color: #d93025;
            margin-bottom: 10px;
        }
        .mistake-item.conceptual-mistake .mistake-title {
            color: #1a73e8;
        }
        .mistake-item.complex-mistake .mistake-title {
            color: #7d33b0;
        }

        .mistake-data {
            font-size: 0.9em;
            margin-top: 10px;
        }
        .mistake-data div {
            padding: 3px 0;
        }
        .mistake-data strong {
            color: #34495e;
            margin-right: 5px;
        }

    </style>
</head>
<body>

<div class="game-container">
    <h1>Financial Ratio Speed Challenge (120s) üß†</h1>
    <p>You have two full minutes per question for complex calculations! Hint cost: -1 point.</p>
    
    <div id="start-screen">
        <p>You will have 120 seconds per question initially. A new "Complex Stage" begins at Level 8!</p>
        <p>Difficulty increases every 5 correct answers, decreasing the time limit by 2 seconds!</p>
        <button id="start-button" onclick="startGame()">Start Challenge &gt;&gt;</button>
    </div>

    <div id="game-area" style="display: none;">
        <div id="score-display">Score: 0 / Level 1</div>
        <div id="timer-bar-container">
            <div id="timer-bar"></div>
        </div>

        <div id="ratio-goal">Calculate: RATIO NAME</div>
        
        <div id="data-area">
            </div>

        <div id="hint-display"></div>

        <div id="input-area">
            
            <div id="dual-input-area" class="input-area-toggle">
                <div class="dual-input-container">
                    <div class="input-group">
                        <label id="label-1" for="answer-input-1">Ratio 1:</label>
                        <input type="number" step="0.01" id="answer-input-1" placeholder="Ratio 1 (e.g., 1.50)">
                    </div>
                    <div class="input-group">
                        <label id="label-2" for="answer-input-2">Ratio 2:</label>
                        <input type="number" step="0.01" id="answer-input-2" placeholder="Ratio 2 (e.g., 20.00)">
                    </div>
                </div>
            </div>

            <div id="single-input-area" class="input-area-toggle">
                <input type="number" step="0.01" id="single-answer-input" placeholder="Enter Ratio (e.g., 1.50)" onkeydown="if(event.key === 'Enter') checkAnswer()">
            </div>
            
             <div id="conceptual-input-area" class="input-area-toggle">
                <input type="text" id="conceptual-answer-input" placeholder="Enter Answer (e.g., LIQUIDITY)" onkeydown="if(event.key === 'Enter') checkAnswer()">
            </div>

            <div style="margin-top: 10px;">
                <button id="submit-button" onclick="checkAnswer()">Submit</button>
                <button id="hint-button" onclick="showHint()">Hint (-1 Point)</button>
            </div>
        </div>

        <div id="feedback-area"></div>
    </div>

    <div id="game-over-screen" style="display: none;">
        <h2>Game Over! üõë</h2>
        <p>Time ran out or you made an error!</p>
        <p class="final-score" style="font-size: 2.2em; color: #1a73e8;">Your Final Score: <span id="final-score">0</span></p>
        <div class="game-over-buttons">
            <button id="review-button" onclick="showReview()">Review Mistakes / Hints</button>
            <button id="restart-button" onclick="startGame()">Try Again</button>
        </div>
    </div>
</div>

<div id="review-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeReview()">&times;</span>
        <h2>Review Mistakes & Hints üßê</h2>
        <div id="mistakes-list">
            </div>
        <p id="no-mistakes-message" style="display: none; text-align: center; color: #00a859; font-weight: bold; font-size: 1.1em;">
            Great job! You made no mistakes and didn't need any hints this session.
        </p>
    </div>
</div>

<script>
    // --- Configuration ---
    const MAX_LIVES = 3;
    const INITIAL_TIME_LIMIT = 120; // 120 Seconds (2 Minutes)
    const TIME_DECREMENT_PER_LEVEL = 2;
    const QUESTIONS_PER_LEVEL = 5;
    const COMPLEX_STAGE_LEVEL = 8; // NEW: Level where complex questions become available
    const PRECISION = 2; 
    const HINT_PENALTY = 1; 
    
    // --- Game State Variables ---
    let score = 0;
    let level = 1;
    let lives = MAX_LIVES;
    let timeLimit = INITIAL_TIME_LIMIT;
    let currentData = {};
    let currentRatioName = '';
    let currentDataLabels = {};
    let currentFormulaText = '';
    let hintUsedForCurrentQuestion = false;
    let isConceptualQuestion = false;
    let isComplexQuestion = false; // NEW
    let correctRatioValues = []; 
    let correctConceptualAnswer = ''; 
    let currentConceptualTopic = ''; 
    let timerInterval;
    let timeLeft = INITIAL_TIME_LIMIT;
    let isDualQuestion = false;
    let mistakes = []; 

    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen');
    const gameArea = document.getElementById('game-area');
    const gameOverScreen = document.getElementById('game-over-screen');
    const scoreDisplay = document.getElementById('score-display');
    const ratioGoal = document.getElementById('ratio-goal');
    const dataArea = document.getElementById('data-area');
    const hintDisplay = document.getElementById('hint-display');
    const hintButton = document.getElementById('hint-button');
    const singleInput = document.getElementById('single-answer-input');
    const dualInputArea = document.getElementById('dual-input-area');
    const singleInputArea = document.getElementById('single-input-area');
    const conceptualInputArea = document.getElementById('conceptual-input-area');
    const conceptualInput = document.getElementById('conceptual-answer-input');
    const answerInput1 = document.getElementById('answer-input-1');
    const answerInput2 = document.getElementById('answer-input-2');
    const label1 = document.getElementById('label-1');
    const label2 = document.getElementById('label-2');
    const timerBar = document.getElementById('timer-bar');
    const feedbackArea = document.getElementById('feedback-area');
    const reviewModal = document.getElementById('review-modal');
    const mistakesList = document.getElementById('mistakes-list');
    const noMistakesMessage = document.getElementById('no-mistakes-message');

    // --- Conceptual Question Data ---
    const conceptualConfigs = [
        { 
            name: "CONCEPT: LIQUIDITY MEASURE", 
            goal: "Which ratio is the MOST restrictive measure of a firm's short-term solvency?", 
            answer: "ACID TEST RATIO", 
            type: "conceptual", 
            area: "LIQUIDITY", 
            formulaText: "The Acid Test Ratio (Quick Ratio) excludes Inventory, which is the least liquid Current Asset." 
        },
        { 
            name: "CONCEPT: LEVERAGE IMPLICATION", 
            goal: "Does a high Debt-to-Equity ratio indicate LOWER or HIGHER financial risk?", 
            answer: "HIGHER", 
            type: "conceptual", 
            area: "LEVERAGE", 
            formulaText: "Higher leverage (more debt relative to equity) increases the risk of default." 
        },
        { 
            name: "CONCEPT: TURNOVER IMPROVEMENT", 
            goal: "If a firm collects cash faster from customers, will its Debtor Turnover (Days) be HIGHER or LOWER?", 
            answer: "LOWER", 
            type: "conceptual", 
            area: "TURNOVER", 
            formulaText: "Collecting cash faster means fewer days to collect, so the Debtor Days ratio is lower." 
        },
        { 
            name: "CONCEPT: EFFICIENCY INDICATOR", 
            goal: "Which category measures how effectively a company uses its assets to generate revenue: Profitability or Efficiency?", 
            answer: "EFFICIENCY", 
            type: "conceptual", 
            area: "EFFICIENCY", 
            formulaText: "Efficiency ratios (like Asset Turnover) focus on the management of assets to generate sales." 
        },
         { 
            name: "CONCEPT: CURRENT RATIO BENCHMARK", 
            goal: "Is a Current Ratio of 0.8 generally considered SAFE or UNSAFE?", 
            answer: "UNSAFE", 
            type: "conceptual", 
            area: "LIQUIDITY", 
            formulaText: "A ratio below 1.0 means Current Liabilities exceed Current Assets, indicating potential short-term liquidity problems." 
        }
    ];

    // --- Complex Question Data (NEW) ---
    const complexConfigs = [
        { 
            name: "COMPLEX: EFFICIENCY & PROFITABILITY", 
            goal: "Calculate the *Net Profit Margin* (%) AND the *Asset Turnover* (times).", 
            data: [
                { label: "Sales Revenue", min: 2000000, max: 5000000, key: 'R' },
                { label: "Net Profit", min: 100000, max: 500000, key: 'NP' },
                { label: "Total Assets", min: 1500000, max: 4000000, key: 'TA' }
            ], 
            formula: (d) => [ 
                (d.NP / d.R) * 100, // Net Profit Margin
                d.R / d.TA          // Asset Turnover
            ], 
            formulaText: "Ratio 1 (NPM): (Net Profit / Revenue) * 100 | Ratio 2 (AT): Revenue / Total Assets",
            labels: ["Net Profit Margin (%)", "Asset Turnover (times)"],
            type: "complex"
        },
        { 
            name: "COMPLEX: DEBT & LIQUIDITY", 
            goal: "Calculate the *Debt-to-Asset Ratio* (%) AND the *Quick Ratio* (Acid Test).", 
            data: [
                { label: "Total Debt", min: 500000, max: 1500000, key: 'TD' },
                { label: "Total Assets", min: 1000000, max: 2500000, key: 'TA' },
                { label: "Current Assets", min: 400000, max: 800000, key: 'CA' },
                { label: "Inventory", min: 50000, max: 200000, key: 'Inv' },
                { label: "Current Liabilities", min: 300000, max: 600000, key: 'CL' }
            ], 
            formula: (d) => [ 
                (d.TD / d.TA) * 100, // Debt-to-Asset Ratio
                (d.CA - d.Inv) / d.CL // Quick Ratio
            ], 
            formulaText: "Ratio 1 (D/A): (Total Debt / Total Assets) * 100 | Ratio 2 (QR): (Current Assets - Inventory) / Current Liabilities",
            labels: ["Debt-to-Asset Ratio (%)", "Quick Ratio (times)"],
            type: "complex"
        },
        { 
            name: "COMPLEX: ROCE & INTEREST COVER", 
            goal: "Calculate the *Return on Capital Employed* (ROCE, %) AND the *Interest Cover* (times).", 
            data: [
                { label: "Operating Profit", min: 200000, max: 600000, key: 'OP' },
                { label: "Total Equity", min: 800000, max: 2000000, key: 'E' },
                { label: "Non-Current Liabilities", min: 300000, max: 800000, key: 'NCL' },
                { label: "Interest Expense", min: 50000, max: 150000, key: 'IE' }
            ], 
            formula: (d) => [ 
                (d.OP / (d.E + d.NCL)) * 100, // ROCE
                d.OP / d.IE                  // Interest Cover
            ], 
            formulaText: "Ratio 1 (ROCE): (Operating Profit / Capital Employed) * 100 | Ratio 2 (IC): Operating Profit / Interest Expense",
            labels: ["ROCE (%)", "Interest Cover (times)"],
            type: "complex"
        }
    ];

    // --- Calculation Question Data (Retained from previous for levels 1-7) ---
    const calculationConfigs = [
        { name: "CURRENT RATIO", data: [{ label: "Current Assets", min: 100000, max: 500000, key: 'CA' }, { label: "Current Liabilities", min: 50000, max: 300000, key: 'CL' }], formula: (d) => [d.CA / d.CL], formulaText: "Current Assets / Current Liabilities", maxLevel: 2, labels: [], type: "calculation" },
        
        { name: "GROSS PROFIT MARGIN (%)", data: [{ label: "Sales Revenue", min: 800000, max: 2000000, key: 'R' }, { label: "Cost of Goods Sold (COGS)", min: 300000, max: 1500000, key: 'COGS' }], formula: (d) => [((d.R - d.COGS) / d.R) * 100], formulaText: "((Revenue - COGS) / Revenue) * 100", maxLevel: 4, labels: [], type: "calculation" },
        
        { name: "GEARING RATIO (%)", data: [{ label: "Total Debt (Long-term)", min: 100000, max: 800000, key: 'D' }, { label: "Total Equity (Shareholders' Funds)", min: 200000, max: 1000000, key: 'E' }], formula: (d) => [(d.D / (d.D + d.E)) * 100], formulaText: "(Total Debt / (Total Debt + Total Equity)) * 100", maxLevel: 99, labels: [], type: "calculation" },
        
        { name: "ASSET TURNOVER (times)", data: [{ label: "Sales Revenue", min: 1000000, max: 5000000, key: 'R' }, { label: "Total Assets", min: 500000, max: 3000000, key: 'TA' }], formula: (d) => [d.R / d.TA], formulaText: "Sales Revenue / Total Assets", maxLevel: 99, labels: [], type: "calculation" },
        
        { name: "ACID TEST RATIO", data: [{ label: "Current Assets", min: 200000, max: 600000, key: 'CA' }, { label: "Inventory", min: 50000, max: 300000, key: 'Inv' }, { label: "Current Liabilities", min: 100000, max: 400000, key: 'CL' }], formula: (d) => [(d.CA - d.Inv) / d.CL], formulaText: "(Current Assets - Inventory) / Current Liabilities", maxLevel: 99, labels: [], type: "calculation" },
        
        { name: "RETURN ON CAPITAL EMPLOYED (ROCE) (%)", data: [
            { label: "Operating Profit", min: 80000, max: 400000, key: 'OP' }, 
            { label: "Total Equity", min: 400000, max: 1500000, key: 'E' },
            { label: "Non-Current Liabilities", min: 100000, max: 600000, key: 'NCL' }
        ], formula: (d) => [(d.OP / (d.E + d.NCL)) * 100], formulaText: "(Operating Profit / (Total Equity + Non-Current Liabilities)) * 100", maxLevel: 99, labels: [], type: "calculation" },

        { name: "INTEREST COVER RATIO (times)", data: [
            { label: "Operating Profit", min: 200000, max: 600000, key: 'OP' }, 
            { label: "Interest Expense", min: 50000, max: 200000, key: 'IE' }
        ], formula: (d) => [d.OP / d.IE], formulaText: "Operating Profit / Interest Expense", maxLevel: 99, labels: [], type: "calculation" },

        { 
            name: "DUAL CALCULATION: GROSS MARGIN & NET MARGIN (%)", 
            data: [
                { label: "Sales Revenue", min: 1000000, max: 3000000, key: 'R' },
                { label: "Cost of Goods Sold (COGS)", min: 400000, max: 1500000, key: 'COGS' },
                { label: "Operating Expenses", min: 100000, max: 500000, key: 'OE' },
                { label: "Interest & Tax Costs", min: 50000, max: 200000, key: 'IT' }
            ], 
            formula: (d) => [ 
                ((d.R - d.COGS) / d.R) * 100, 
                ((d.R - d.COGS - d.OE - d.IT) / d.R) * 100
            ], 
            formulaText: "Gross Margin: ((R - COGS) / R) * 100 | Net Margin: ((R - COGS - OE - IT) / R) * 100",
            maxLevel: 99,
            labels: ["Gross Margin", "Net Margin"],
            type: "calculation"
        }
    ];
    
    // --- Game Flow Functions ---

    function startGame() {
        score = 0;
        level = 1;
        lives = MAX_LIVES;
        timeLimit = INITIAL_TIME_LIMIT;
        mistakes = []; 
        
        startScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        reviewModal.style.display = 'none';
        gameArea.style.display = 'block';
        hintDisplay.style.display = 'none'; 
        
        loadNewQuestion();
    }

    function generateRandomValue(min, max) {
        return Math.round((Math.floor(Math.random() * (max - min + 1)) + min) / 1000) * 1000;
    }

    function formatCurrency(value) {
        return '$' + value.toLocaleString('en-US');
    }

    function loadNewQuestion() {
        stopTimer();
        
        // Clear all inputs and feedback
        singleInput.value = '';
        answerInput1.value = '';
        answerInput2.value = '';
        conceptualInput.value = '';
        feedbackArea.innerHTML = '';
        hintDisplay.style.display = 'none'; 
        hintUsedForCurrentQuestion = false; 
        isComplexQuestion = false; // Reset complexity flag
        
        let selectedConfig;
        
        // --- Question Selection Logic ---
        
        const isComplexRoll = level >= COMPLEX_STAGE_LEVEL && Math.random() < 0.35; // 35% chance for complex at Level 8+
        const isConceptualRoll = !isComplexRoll && Math.random() < 0.25; // 25% chance for conceptual

        if (isComplexRoll) {
            selectedConfig = complexConfigs[Math.floor(Math.random() * complexConfigs.length)];
            isConceptualQuestion = false;
            isComplexQuestion = true;
        } else if (isConceptualRoll) {
            selectedConfig = conceptualConfigs[Math.floor(Math.random() * conceptualConfigs.length)];
            isConceptualQuestion = true;
            isComplexQuestion = false;
        } else {
             // Filter calculation ratios by level
            const availableRatios = calculationConfigs.filter(r => {
                return r.maxLevel > level || level >= COMPLEX_STAGE_LEVEL;
            });

            // Randomly select one from available calculation ratios
            selectedConfig = availableRatios[Math.floor(Math.random() * availableRatios.length)];
            isConceptualQuestion = false;
            isComplexQuestion = false;
        }
        
        // Store info
        currentRatioName = selectedConfig.name;
        currentFormulaText = selectedConfig.formulaText; 
        isDualQuestion = selectedConfig.labels && selectedConfig.labels.length === 2;

        // --- Setup Question UI ---
        ratioGoal.textContent = selectedConfig.goal;
        ratioGoal.className = isConceptualQuestion ? 'conceptual-goal' : (isComplexQuestion ? 'complex-goal' : '');
        dataArea.innerHTML = ''; 

        // Handle Input Fields
        if (isConceptualQuestion) {
            conceptualInputArea.style.display = 'flex';
            singleInputArea.style.display = 'none';
            dualInputArea.style.display = 'none';
            
            // Set conceptual answer and topic for logging
            correctConceptualAnswer = selectedConfig.answer.toUpperCase();
            currentConceptualTopic = selectedConfig.area; 
            conceptualInput.focus();
            dataArea.innerHTML = `<div style="text-align: center; font-style: italic; color: #777;">Topic: ${selectedConfig.area}</div>`;
        } else {
            // Setup for Calculation and Complex Questions
            conceptualInputArea.style.display = 'none';
            singleInputArea.style.display = isDualQuestion ? 'none' : 'flex';
            dualInputArea.style.display = isDualQuestion ? 'block' : 'none';

            let dataHtml = '';
            currentData = {};
            currentDataLabels = {}; 

            selectedConfig.data.forEach(item => {
                const value = generateRandomValue(item.min, item.max);
                currentData[item.key] = value;
                currentDataLabels[item.label] = formatCurrency(value);
                dataHtml += `<div class="data-point"><span class="data-label">${item.label}:</span><span>${formatCurrency(value)}</span></div>`;
            });
            dataArea.innerHTML = dataHtml;
            
            correctRatioValues = selectedConfig.formula(currentData).map(val => 
                parseFloat(val.toFixed(PRECISION))
            );
            
            if (isDualQuestion) {
                // Dual input setup (used for Complex questions as well)
                label1.textContent = `${selectedConfig.labels[0]}:`;
                label2.textContent = `${selectedConfig.labels[1]}:`;
                answerInput1.focus();
            } else {
                singleInput.focus();
            }
        }
        
        const timeReduction = Math.floor(score / QUESTIONS_PER_LEVEL) * TIME_DECREMENT_PER_LEVEL;
        timeLimit = Math.max(5, INITIAL_TIME_LIMIT - timeReduction);
        
        timeLeft = timeLimit;
        updateScoreDisplay();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            
            const progressPercentage = (timeLeft / timeLimit) * 100;
            timerBar.style.width = `${progressPercentage}%`;

            if (progressPercentage > 66) {
                timerBar.style.backgroundColor = '#00a859';
            } else if (progressPercentage > 33) {
                timerBar.style.backgroundColor = '#fbbc05';
            } else {
                timerBar.style.backgroundColor = '#d93025';
            }

            if (timeLeft <= 0) {
                timeExpired();
            }
        }, 100);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function showHint() { 
        if (hintUsedForCurrentQuestion) return;

        stopTimer();
        score = Math.max(0, score - HINT_PENALTY); 
        hintUsedForCurrentQuestion = true;
        
        hintDisplay.innerHTML = `*Formula/Concept Hint:* ${currentFormulaText}`;
        hintDisplay.style.display = 'block';
        
        showFeedback(`‚ö†Ô∏è Hint Used! Score -${HINT_PENALTY} Point.`, false);
        updateScoreDisplay();
        
        setTimeout(startTimer, 1000); 
    }

    function checkAnswer() {
        stopTimer();
        
        let isCorrect = false;
        let submittedAnswers = [];

        if (isConceptualQuestion) {
            const submittedText = conceptualInput.value.toUpperCase().trim();
            isCorrect = (submittedText === correctConceptualAnswer);
            submittedAnswers = [submittedText];
        } else if (isDualQuestion || isComplexQuestion) {
            submittedAnswers = [answerInput1.value, answerInput2.value];
            isCorrect = validateCalculationAnswers(submittedAnswers);
        } else {
            submittedAnswers = [singleInput.value];
            isCorrect = validateCalculationAnswers(submittedAnswers);
        }

        if (isCorrect) {
            score++;
            showFeedback("‚úÖ Correct! +1 Point", true);
            
            if (hintUsedForCurrentQuestion) {
                 logMistake('CORRECT (Hint Used)', submittedAnswers.join(' / '));
            }

            if (score > 0 && score % QUESTIONS_PER_LEVEL === 0) {
                levelUp();
            } else {
                setTimeout(loadNewQuestion, 1200);
            }
        } else {
            // Log mistake 
            logMistake('INCORRECT', submittedAnswers.join(' / '));

            let correctDisplay = isConceptualQuestion 
                ? correctConceptualAnswer 
                : correctRatioValues.map(v => v.toFixed(PRECISION)).join(' / ');

            let feedbackMessage = `‚ùå Wrong! Correct Answer: ${correctDisplay}`;
            showFeedback(feedbackMessage, false);
            handleIncorrectAnswer();
        }
    }

    function validateCalculationAnswers(submitted) {
        const tolerance = 0.01;
        let allCorrect = true;

        if (submitted.length !== correctRatioValues.length) return false;

        for (let i = 0; i < submitted.length; i++) {
            const submittedValue = parseFloat(submitted[i]);
            if (isNaN(submittedValue)) return false;

            const roundedSubmitted = parseFloat(submittedValue.toFixed(PRECISION));
            
            if (Math.abs(roundedSubmitted - correctRatioValues[i]) > tolerance) {
                allCorrect = false;
                break;
            }
        }
        return allCorrect;
    }

    function logMistake(type, userAnswer) {
        const dataForReview = isConceptualQuestion 
            ? { "Topic": currentConceptualTopic } 
            : currentDataLabels;

        mistakes.push({
            type: type, 
            ratio: currentRatioName,
            formula: currentFormulaText,
            data: dataForReview,
            correct: isConceptualQuestion ? correctConceptualAnswer : correctRatioValues.map(v => v.toFixed(PRECISION)).join(' / '),
            user: userAnswer,
            hintUsed: hintUsedForCurrentQuestion,
            isConceptual: isConceptualQuestion,
            isComplex: isComplexQuestion // Log complexity
        });
    }

    function handleIncorrectAnswer() {
        lives--;
        if (lives <= 0) {
            setTimeout(gameOver, 1500);
        } else {
            updateScoreDisplay();
            setTimeout(loadNewQuestion, 1500); 
        }
    }

    function timeExpired() {
        stopTimer();
        showFeedback("‚è∞ Time Expired!", false);
        logMistake('TIMEOUT', 'N/A (Timeout)'); 
        handleIncorrectAnswer();
    }

    function levelUp() {
        level++;
        showFeedback(`‚≠ê LEVEL UP! Now Level ${level}`, true);
        setTimeout(loadNewQuestion, 2000);
    }

    function updateScoreDisplay() {
        scoreDisplay.innerHTML = `Score: ${score} / Level ${level} / Lives: ${'‚ù§Ô∏è'.repeat(lives)}`;
    }

    function showFeedback(message, isCorrect) {
        feedbackArea.innerHTML = `<div class="feedback ${isCorrect ? 'correct-feedback' : 'incorrect-feedback'}">${message}</div>`;
    }

    function gameOver() {
        stopTimer();
        gameArea.style.display = 'none';
        gameOverScreen.style.display = 'block';
        document.getElementById('final-score').textContent = score;
    }
    
    // --- Review Functions ---
    function showReview() {
        gameOverScreen.style.display = 'none';
        mistakesList.innerHTML = ''; 

        const reviewItems = mistakes.filter(m => m.type !== 'CORRECT (Hint Used)' || m.hintUsed);

        if (reviewItems.length === 0) {
            noMistakesMessage.style.display = 'block';
            mistakesList.style.display = 'none';
        } else {
            noMistakesMessage.style.display = 'none';
            mistakesList.style.display = 'block';

            reviewItems.forEach((item, index) => {
                let dataHtml = '';
                for (const label in item.data) {
                    dataHtml += `<div><strong>${label}:</strong> ${item.data[label]}</div>`;
                }

                const titleText = item.type === 'CORRECT (Hint Used)' 
                    ? `Hint Used (Question ${index + 1}): ${item.ratio}`
                    : `Mistake (Question ${index + 1}): ${item.ratio}`;
                
                let typeClass = '';
                if (item.hintUsed && item.type === 'CORRECT (Hint Used)') {
                    typeClass = 'hint-used';
                } else if (item.isConceptual) {
                    typeClass = 'conceptual-mistake';
                } else if (item.isComplex) {
                    typeClass = 'complex-mistake';
                }

                const mistakeItem = `
                    <div class="mistake-item ${typeClass.trim()}">
                        <div class="mistake-title">${titleText}</div>
                        
                        <div class="mistake-data">
                            <strong>Hint/Explanation:</strong> <span style="color: #6c757d;">${item.formula}</span>
                        </div>
                        ${item.type !== 'CORRECT (Hint Used)' ? 
                            `<div class="mistake-data">
                                <strong>Your Answer(s):</strong> <span style="color: #d93025;">${item.user}</span>
                            </div>` : ''}
                        
                        <div class="mistake-data">
                            <strong>Correct Answer(s):</strong> <span style="color: #00a859;">${item.correct}</span>
                        </div>
                        <p style="font-weight: bold; margin-top: 10px; color: #34495e;">${item.isConceptual ? 'Topic Context:' : 'Input Data Used:'}</p>
                        <div class="mistake-data" style="border-top: 1px dashed #ccc;">${dataHtml}</div>
                    </div>
                `;
                mistakesList.innerHTML += mistakeItem;
            });
        }
        
        reviewModal.style.display = 'block';
    }

    function closeReview() {
        reviewModal.style.display = 'none';
        gameOverScreen.style.display = 'block';
    }

    // Initialize: Show start screen on load
    document.addEventListener('DOMContentLoaded', () => {
        startScreen.style.display = 'block';
        gameArea.style.display = 'none';
        gameOverScreen.style.display = 'none';
    });
</script>

</body>
</html>